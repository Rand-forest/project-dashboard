<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Project Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@400;600;700&family=Work+Sans:wght@400;500;600&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --terra: #C75B39;
      --terra-light: #E08B6F;
      --sage: #7A9D7E;
      --cream: #FAF7F2;
      --charcoal: #2D3436;
      --warm-gray: #6C757D;
      --success-green: #22C55E;
    }
    
    body {
      font-family: 'Work Sans', sans-serif;
      background: linear-gradient(135deg, #FAF7F2 0%, #F5EEE6 100%);
      min-height: 100vh;
    }
    
    h1, h2, h3, h4 {
      font-family: 'Crimson Pro', serif;
    }
    
    .project-card {
      background: white;
      border: 2px solid #E8DED0;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .project-card:hover {
      border-color: var(--terra);
      transform: translateY(-4px);
      box-shadow: 0 12px 24px rgba(199, 91, 57, 0.15);
    }
    
    .btn-primary {
      background: linear-gradient(135deg, var(--terra) 0%, var(--terra-light) 100%);
      transition: all 0.3s ease;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(199, 91, 57, 0.3);
    }
    
    .status-badge {
      font-weight: 500;
      letter-spacing: 0.5px;
      text-transform: uppercase;
      font-size: 0.7rem;
    }
    
    .loading-spinner {
      border: 3px solid rgba(199, 91, 57, 0.1);
      border-radius: 50%;
      border-top: 3px solid var(--terra);
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .animate-in {
      animation: fadeIn 0.5s ease-out;
    }
    
    .progress-ring {
      transition: stroke-dashoffset 0.5s ease;
    }
    
    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: var(--terra);
      ring: 2px;
      ring-color: rgba(199, 91, 57, 0.2);
    }
    
    .modal-backdrop {
      backdrop-filter: blur(4px);
      animation: fadeIn 0.2s ease;
    }

    .gantt-bar {
      transition: all 0.3s ease;
    }
    .gantt-bar:hover {
      filter: brightness(1.1);
      transform: scaleY(1.1);
    }

    .drag-handle {
      cursor: grab;
    }
    .drag-handle:active {
      cursor: grabbing;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useCallback } = React;

    // ============================================
    // CONFIGURATION - EDIT THESE VALUES
    // ============================================
    const CONFIG = {
      CLIENT_ID: '50000852363-lfo75b0tdqj9ogomusjbt54a57qgfhcr.apps.googleusercontent.com',
      API_KEY: 'AIzaSyBf95XCReFCrnh9b-5zmRX9PDGzQEJqV_M',
      SPREADSHEET_ID: '1HASV36fYF80j30LuCQxUfiGtlxi6Hc-PIGBPZ7WvAUc',
      SHEETS: {
        PROJECTS: 'Projects',
        TASKS: 'Tasks'
      },
      DISCOVERY_DOCS: ['https://sheets.googleapis.com/$discovery/rest?version=v4'],
      SCOPES: 'https://www.googleapis.com/auth/spreadsheets'
    };

    // ============================================
    // GOOGLE SHEETS API CLIENT
    // ============================================
    class SheetsClient {
      constructor() {
        this.isSignedIn = false;
        this.gapiLoaded = false;
        this.gisLoaded = false;
        this.tokenClient = null;
      }

      async initialize() {
        return new Promise((resolve, reject) => {
          const gapiScript = document.createElement('script');
          gapiScript.src = 'https://apis.google.com/js/api.js';
          gapiScript.onload = () => {
            gapi.load('client', async () => {
              await gapi.client.init({
                apiKey: CONFIG.API_KEY,
                discoveryDocs: CONFIG.DISCOVERY_DOCS,
              });
              this.gapiLoaded = true;
              if (this.gisLoaded) resolve();
            });
          };
          document.head.appendChild(gapiScript);

          const gisScript = document.createElement('script');
          gisScript.src = 'https://accounts.google.com/gsi/client';
          gisScript.onload = () => {
            this.tokenClient = google.accounts.oauth2.initTokenClient({
              client_id: CONFIG.CLIENT_ID,
              scope: CONFIG.SCOPES,
              callback: '', 
            });
            this.gisLoaded = true;
            if (this.gapiLoaded) resolve();
          };
          document.head.appendChild(gisScript);
        });
      }

      async authorize() {
        return new Promise((resolve, reject) => {
          this.tokenClient.callback = async (response) => {
            if (response.error) {
              reject(response);
              return;
            }
            this.isSignedIn = true;
            resolve(response);
          };
          
          if (gapi.client.getToken() === null) {
            this.tokenClient.requestAccessToken({ prompt: 'consent' });
          } else {
            this.tokenClient.requestAccessToken({ prompt: '' });
          }
        });
      }

      async getProjects() {
        const response = await gapi.client.sheets.spreadsheets.values.get({
          spreadsheetId: CONFIG.SPREADSHEET_ID,
          range: `${CONFIG.SHEETS.PROJECTS}!A2:H`,
        });
        
        const rows = response.result.values || [];
        return rows.map(row => ({
          id: row[0] || '',
          name: row[1] || '',
          description: row[2] || '',
          status: row[3] || 'active',
          priority: row[4] || 'medium',
          deadline: row[5] || '',
          createdAt: row[6] || new Date().toISOString(),
          createdBy: row[7] || ''
        }));
      }

      async getTasks() {
        const response = await gapi.client.sheets.spreadsheets.values.get({
          spreadsheetId: CONFIG.SPREADSHEET_ID,
          range: `${CONFIG.SHEETS.TASKS}!A2:I`,
        });
        
        const rows = response.result.values || [];
        return rows.map((row, index) => {
          // Robust ordering logic: Parse existing column I, fallback to createdAt, fallback to generic index
          let orderVal = Date.now() + index; 
          if (row[8] !== undefined && row[8] !== '') {
            orderVal = parseFloat(row[8]);
          } else if (row[4]) {
            const parsed = Date.parse(row[4]);
            if (!isNaN(parsed)) orderVal = parsed;
          }
          
          return {
            id: row[0] || '',
            projectId: row[1] || '',
            title: row[2] || '',
            completed: row[3] === 'TRUE',
            createdAt: row[4] || new Date().toISOString(),
            createdBy: row[5] || '',
            startDate: row[6] || '',
            endDate: row[7] || '',
            order: orderVal
          };
        });
      }

      async addProject(project, userName) {
        const values = [[
          project.id,
          project.name,
          project.description,
          project.status,
          project.priority,
          project.deadline,
          project.createdAt,
          userName
        ]];

        await gapi.client.sheets.spreadsheets.values.append({
          spreadsheetId: CONFIG.SPREADSHEET_ID,
          range: `${CONFIG.SHEETS.PROJECTS}!A2`,
          valueInputOption: 'USER_ENTERED',
          resource: { values }
        });
      }

      async addTask(task, userName) {
        const values = [[
          task.id,
          task.projectId,
          task.title,
          task.completed ? 'TRUE' : 'FALSE',
          task.createdAt,
          userName,
          task.startDate || '',
          task.endDate || '',
          task.order ? String(task.order) : String(Date.now()) 
        ]];

        await gapi.client.sheets.spreadsheets.values.append({
          spreadsheetId: CONFIG.SPREADSHEET_ID,
          range: `${CONFIG.SHEETS.TASKS}!A2`,
          valueInputOption: 'USER_ENTERED',
          resource: { values }
        });
      }

      async updateProject(projectId, updates) {
        const projects = await this.getProjects();
        const rowIndex = projects.findIndex(p => p.id === projectId);
        if (rowIndex === -1) return;

        const project = { ...projects[rowIndex], ...updates };
        const values = [[
          project.id,
          project.name,
          project.description,
          project.status,
          project.priority,
          project.deadline,
          project.createdAt,
          project.createdBy
        ]];

        await gapi.client.sheets.spreadsheets.values.update({
          spreadsheetId: CONFIG.SPREADSHEET_ID,
          range: `${CONFIG.SHEETS.PROJECTS}!A${rowIndex + 2}`,
          valueInputOption: 'USER_ENTERED',
          resource: { values }
        });
      }

      async updateTask(taskId, updates) {
        const tasks = await this.getTasks();
        const rowIndex = tasks.findIndex(t => t.id === taskId);
        if (rowIndex === -1) return;

        const task = { ...tasks[rowIndex], ...updates };
        const values = [[
          task.id,
          task.projectId,
          task.title,
          task.completed ? 'TRUE' : 'FALSE',
          task.createdAt,
          task.createdBy,
          task.startDate || '',
          task.endDate || '',
          task.order !== undefined ? String(task.order) : String(Date.parse(task.createdAt))
        ]];

        await gapi.client.sheets.spreadsheets.values.update({
          spreadsheetId: CONFIG.SPREADSHEET_ID,
          range: `${CONFIG.SHEETS.TASKS}!A${rowIndex + 2}`,
          valueInputOption: 'USER_ENTERED',
          resource: { values }
        });
      }

      async deleteTask(taskId) {
        const tasks = await this.getTasks();
        const rowIndex = tasks.findIndex(t => t.id === taskId);
        if (rowIndex === -1) return;

        await gapi.client.sheets.spreadsheets.batchUpdate({
          spreadsheetId: CONFIG.SPREADSHEET_ID,
          resource: {
            requests: [{
              deleteDimension: {
                range: {
                  sheetId: 1, 
                  dimension: 'ROWS',
                  startIndex: rowIndex + 1,
                  endIndex: rowIndex + 2
                }
              }
            }]
          }
        });
      }

      async deleteProject(projectId) {
        const projects = await this.getProjects();
        const rowIndex = projects.findIndex(p => p.id === projectId);
        if (rowIndex === -1) return;

        await gapi.client.sheets.spreadsheets.batchUpdate({
          spreadsheetId: CONFIG.SPREADSHEET_ID,
          resource: {
            requests: [{
              deleteDimension: {
                range: {
                  sheetId: 0, 
                  dimension: 'ROWS',
                  startIndex: rowIndex + 1,
                  endIndex: rowIndex + 2
                }
              }
            }]
          }
        });

        const tasks = await this.getTasks();
        const taskRowsToDelete = tasks
          .map((t, i) => ({ task: t, index: i }))
          .filter(({ task }) => task.projectId === projectId)
          .reverse();

        for (const { index } of taskRowsToDelete) {
          await gapi.client.sheets.spreadsheets.batchUpdate({
            spreadsheetId: CONFIG.SPREADSHEET_ID,
            resource: {
              requests: [{
                deleteDimension: {
                  range: {
                    sheetId: 1, 
                    dimension: 'ROWS',
                    startIndex: index + 1,
                    endIndex: index + 2
                  }
                }
              }]
            }
          });
        }
      }

      getUserEmail() {
        const token = gapi.client.getToken();
        if (!token) return 'Unknown User';
        
        try {
          const base64Url = token.access_token.split('.')[1];
          const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
          const jsonPayload = decodeURIComponent(atob(base64).split('').map(c => {
            return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
          }).join(''));
          return JSON.parse(jsonPayload).email || 'Unknown User';
        } catch (e) {
          return 'Unknown User';
        }
      }
    }

    const sheetsClient = new SheetsClient();

    // ============================================
    // GANTT VIEW COMPONENT
    // ============================================
    function GanttView({ tasks }) {
      const validTasks = tasks
        .filter(t => t.startDate && t.endDate)
        .map(t => ({
          ...t,
          start: new Date(t.startDate),
          end: new Date(t.endDate)
        }))
        .sort((a, b) => a.start - b.start);

      if (validTasks.length === 0) {
        return (
          <div className="text-center py-16 animate-in border-2 border-dashed border-gray-200 rounded-xl">
            <div className="text-4xl mb-3">üìä</div>
            <p className="text-lg font-medium" style={{ color: 'var(--charcoal)' }}>No timeline data available</p>
            <p className="text-sm mt-1" style={{ color: 'var(--warm-gray)' }}>
              Add a Start Date and End Date to your tasks to generate a Gantt chart.
            </p>
          </div>
        );
      }

      const minDate = new Date(Math.min(...validTasks.map(t => t.start)));
      const maxDate = new Date(Math.max(...validTasks.map(t => t.end)));
      minDate.setDate(minDate.getDate() - 2);
      maxDate.setDate(maxDate.getDate() + 2);
      const totalTime = maxDate.getTime() - minDate.getTime();

      return (
        <div className="mt-2 border-2 border-gray-200 rounded-xl overflow-hidden bg-white animate-in">
          <div className="flex border-b-2 border-gray-200 bg-gray-50">
            <div className="w-48 lg:w-64 flex-shrink-0 p-4 font-bold text-sm border-r-2 border-gray-200" style={{ color: 'var(--charcoal)' }}>
              Task Name
            </div>
            <div className="flex-1 relative p-4 h-12">
              <span className="absolute left-4 top-4 text-xs font-bold text-gray-400">{minDate.toLocaleDateString()}</span>
              <span className="absolute right-4 top-4 text-xs font-bold text-gray-400">{maxDate.toLocaleDateString()}</span>
            </div>
          </div>

          <div className="divide-y divide-gray-100">
            {validTasks.map(task => {
              const leftOffset = ((task.start.getTime() - minDate.getTime()) / totalTime) * 100;
              const duration = Math.max(1000 * 3600 * 24, task.end.getTime() - task.start.getTime());
              const width = (duration / totalTime) * 100;

              return (
                <div key={task.id} className="flex hover:bg-gray-50 transition h-14 group">
                  <div className="w-48 lg:w-64 flex-shrink-0 p-4 text-sm truncate border-r-2 border-gray-200 flex items-center" title={task.title}>
                    <span style={{ color: 'var(--charcoal)' }} className={`font-medium ${task.completed ? 'line-through opacity-50' : ''}`}>
                      {task.title}
                    </span>
                  </div>
                  <div className="flex-1 relative px-4">
                    <div 
                      className="gantt-bar absolute top-3 bottom-3 rounded shadow flex items-center px-3 text-xs font-bold text-white overflow-hidden whitespace-nowrap cursor-help"
                      style={{ 
                        left: `calc(${leftOffset}% + 1rem)`, 
                        width: `calc(${width}% - 2rem)`,
                        backgroundColor: task.completed ? 'var(--success-green)' : 'var(--terra)',
                        opacity: task.completed ? 0.9 : 1
                      }}
                      title={`${task.title}\nStart: ${task.startDate}\nEnd: ${task.endDate}`}
                    >
                      {width > 15 ? task.title : ''}
                    </div>
                  </div>
                </div>
              );
            })}
          </div>
        </div>
      );
    }

    // ============================================
    // MAIN APP COMPONENT
    // ============================================
    function App() {
      const [initialized, setInitialized] = useState(false);
      const [authenticated, setAuthenticated] = useState(false);
      const [loading, setLoading] = useState(true);
      const [projects, setProjects] = useState([]);
      const [tasks, setTasks] = useState([]);
      const [selectedProject, setSelectedProject] = useState(null);
      const [view, setView] = useState('dashboard');
      const [showAddProject, setShowAddProject] = useState(false);
      const [error, setError] = useState('');
      const [userName, setUserName] = useState('');

      useEffect(() => {
        const init = async () => {
          try {
            await sheetsClient.initialize();
            setInitialized(true);
            setLoading(false);
          } catch (err) {
            setError('Failed to initialize Google API. Please check your configuration.');
            setLoading(false);
          }
        };
        init();
      }, []);

      const handleSignIn = async () => {
        try {
          setLoading(true);
          setError('');
          await sheetsClient.authorize();
          setAuthenticated(true);
          setUserName(sheetsClient.getUserEmail());
          await loadData();
        } catch (err) {
          setError('Authentication failed. Please try again.');
          setLoading(false);
        }
      };

      const loadData = async () => {
        try {
          const [projectsData, tasksData] = await Promise.all([
            sheetsClient.getProjects(),
            sheetsClient.getTasks()
          ]);
          setProjects(projectsData);
          setTasks(tasksData);
          setLoading(false);
        } catch (err) {
          setError('Failed to load data. Please check your sheet configuration.');
          setLoading(false);
        }
      };

      const refreshData = useCallback(async () => {
        if (!authenticated) return;
        try {
          await loadData();
        } catch (err) {
          console.error('Failed to refresh data:', err);
        }
      }, [authenticated]);

      useEffect(() => {
        if (!authenticated) return;
        const interval = setInterval(refreshData, 30000);
        return () => clearInterval(interval);
      }, [authenticated, refreshData]);

      const addProject = async (projectData) => {
        try {
          const newProject = {
            id: String(Date.now()),
            ...projectData,
            createdAt: new Date().toISOString()
          };
          await sheetsClient.addProject(newProject, userName);
          await refreshData();
          setShowAddProject(false);
        } catch (err) {
          setError('Failed to add project. Please try again.');
        }
      };

      const updateProject = async (projectId, updates) => {
        try {
          await sheetsClient.updateProject(projectId, updates);
          await refreshData();
        } catch (err) {
          setError('Failed to update project. Please try again.');
        }
      };

      const deleteProject = async (projectId) => {
        if (!confirm('Are you sure you want to delete this project? This will also delete all associated tasks.')) {
          return;
        }
        try {
          await sheetsClient.deleteProject(projectId);
          await refreshData();
          if (selectedProject?.id === projectId) {
            setSelectedProject(null);
            setView('dashboard');
          }
        } catch (err) {
          setError('Failed to delete project. Please try again.');
        }
      };

      const addTask = async (projectId, taskData) => {
        try {
          const newTask = {
            id: String(Date.now()),
            projectId,
            ...taskData,
            completed: false,
            createdAt: new Date().toISOString(),
            order: Date.now() 
          };
          await sheetsClient.addTask(newTask, userName);
          await refreshData();
        } catch (err) {
          setError('Failed to add task. Please try again.');
        }
      };

      const toggleTask = async (taskId) => {
        try {
          const task = tasks.find(t => t.id === taskId);
          if (!task) return;
          await sheetsClient.updateTask(taskId, { completed: !task.completed });
          await refreshData();
        } catch (err) {
          setError('Failed to update task status. Please try again.');
        }
      };

      const editTask = async (taskId, updates) => {
        try {
          await sheetsClient.updateTask(taskId, updates);
          await refreshData();
        } catch (err) {
          setError('Failed to edit task. Please try again.');
        }
      };

      const reorderTask = async (taskId, newOrder) => {
        // Use functional state update to prevent stale closures
        setTasks(prevTasks => prevTasks.map(t => 
          t.id === taskId ? { ...t, order: newOrder } : t
        ));
        
        try {
          await sheetsClient.updateTask(taskId, { order: newOrder });
          // Note: Intentionally avoiding an immediate refreshData() here. 
          // Google Sheets has a read-after-write delay. Refreshing immediately fetches 
          // the old un-synced order and makes the UI snap back. The 30s poll will catch it later!
        } catch (err) {
          setError('Failed to save task order.');
          refreshData(); // Only refresh to undo the optimistic update if it failed
        }
      };

      const deleteTask = async (taskId) => {
        if (!confirm('Are you sure you want to delete this task?')) return;
        try {
          await sheetsClient.deleteTask(taskId);
          await refreshData();
        } catch (err) {
          setError('Failed to delete task. Please try again.');
        }
      };

      const getProjectWithTasks = (projectId) => {
        const project = projects.find(p => p.id === projectId);
        if (!project) return null;
        return {
          ...project,
          tasks: tasks.filter(t => t.projectId === projectId)
        };
      };

      if (!initialized && loading) {
        return (
          <div className="min-h-screen flex items-center justify-center">
            <div className="text-center">
              <div className="loading-spinner mx-auto mb-4"></div>
              <p className="text-warm-gray">Initializing...</p>
            </div>
          </div>
        );
      }

      if (!authenticated) {
        return <SignInScreen onSignIn={handleSignIn} error={error} />;
      }

      if (loading) {
        return (
          <div className="min-h-screen flex items-center justify-center">
            <div className="text-center">
              <div className="loading-spinner mx-auto mb-4"></div>
              <p className="text-warm-gray">Loading your projects...</p>
            </div>
          </div>
        );
      }

      return (
        <div className="min-h-screen">
          <Header
            projectCount={projects.length}
            onAddProject={() => setShowAddProject(true)}
            onRefresh={refreshData}
            userName={userName}
          />

          <main className="max-w-7xl mx-auto px-4 py-8 sm:px-6 lg:px-8">
            {error && (
              <div className="mb-6 p-4 bg-red-50 border-2 border-red-200 rounded-lg">
                <p className="text-red-800">{error}</p>
                <button
                  onClick={() => setError('')}
                  className="mt-2 text-sm text-red-600 hover:text-red-800"
                >
                  Dismiss
                </button>
              </div>
            )}

            {view === 'dashboard' ? (
              <DashboardView
                projects={projects.map(p => getProjectWithTasks(p.id))}
                onSelectProject={(p) => {
                  setSelectedProject(p);
                  setView('project');
                }}
                onDeleteProject={deleteProject}
              />
            ) : (
              <ProjectView
                project={getProjectWithTasks(selectedProject.id)}
                onBack={() => {
                  setView('dashboard');
                  setSelectedProject(null);
                }}
                onUpdateProject={updateProject}
                onAddTask={addTask}
                onToggleTask={toggleTask}
                onEditTask={editTask}
                onDeleteTask={deleteTask}
                onReorderTask={reorderTask}
              />
            )}
          </main>

          {showAddProject && (
            <AddProjectModal
              onAdd={addProject}
              onClose={() => setShowAddProject(false)}
            />
          )}
        </div>
      );
    }

    // ============================================
    // SIGN IN SCREEN
    // ============================================
    function SignInScreen({ onSignIn, error }) {
      return (
        <div className="min-h-screen flex items-center justify-center p-4">
          <div className="max-w-md w-full text-center animate-in">
            <div className="mb-8">
              <h1 className="text-5xl font-bold mb-3" style={{ color: 'var(--terra)' }}>
                Project Dashboard
              </h1>
              <p className="text-warm-gray text-lg">
                Collaborative project management powered by Google Sheets
              </p>
            </div>

            {error && (
              <div className="mb-6 p-4 bg-red-50 border-2 border-red-200 rounded-lg">
                <p className="text-red-800 text-sm">{error}</p>
              </div>
            )}

            <button
              onClick={onSignIn}
              className="w-full py-4 px-6 btn-primary text-white rounded-lg font-semibold text-lg shadow-lg"
            >
              Sign in with Google
            </button>

            <p className="mt-6 text-sm text-warm-gray">
              Your data is stored in your Google Sheet.
              <br />
              Multiple team members can collaborate in real-time.
            </p>
          </div>
        </div>
      );
    }

    // ============================================
    // HEADER COMPONENT
    // ============================================
    function Header({ projectCount, onAddProject, onRefresh, userName }) {
      return (
        <header className="bg-white shadow-sm border-b-2 border-gray-200">
          <div className="max-w-7xl mx-auto px-4 py-5 sm:px-6 lg:px-8">
            <div className="flex justify-between items-center">
              <div>
                <h1 className="text-3xl font-bold" style={{ color: 'var(--charcoal)' }}>
                  Project Dashboard
                </h1>
                <p className="text-sm mt-1" style={{ color: 'var(--warm-gray)' }}>
                  {projectCount} projects ‚Ä¢ {userName}
                </p>
              </div>
              <div className="flex gap-3">
                <button
                  onClick={onRefresh}
                  className="px-4 py-2 bg-white border-2 border-gray-300 rounded-lg hover:border-gray-400 transition font-medium"
                  style={{ color: 'var(--charcoal)' }}
                >
                  ‚Üª Refresh
                </button>
                <button
                  onClick={onAddProject}
                  className="px-6 py-2 btn-primary text-white rounded-lg font-semibold shadow-md"
                >
                  + New Project
                </button>
              </div>
            </div>
          </div>
        </header>
      );
    }

    // ============================================
    // DASHBOARD VIEW
    // ============================================
    function DashboardView({ projects, onSelectProject, onDeleteProject }) {
      const getProjectStats = (project) => {
        const total = project.tasks?.length || 0;
        const completed = project.tasks?.filter(t => t.completed).length || 0;
        return { total, completed, progress: total > 0 ? (completed / total) * 100 : 0 };
      };

      const getStatusColor = (status) => {
        switch (status) {
          case 'active': return 'bg-green-100 text-green-800';
          case 'on-hold': return 'bg-yellow-100 text-yellow-800';
          case 'completed': return 'bg-blue-100 text-blue-800';
          default: return 'bg-gray-100 text-gray-800';
        }
      };

      const getPriorityColor = (priority) => {
        switch (priority) {
          case 'high': return 'var(--terra)';
          case 'medium': return 'var(--terra-light)';
          case 'low': return 'var(--sage)';
          default: return 'var(--warm-gray)';
        }
      };

      if (projects.length === 0) {
        return (
          <div className="text-center py-16 animate-in">
            <div className="text-6xl mb-4">üìã</div>
            <h3 className="text-2xl font-semibold mb-2" style={{ color: 'var(--charcoal)' }}>
              No projects yet
            </h3>
            <p style={{ color: 'var(--warm-gray)' }}>
              Click "New Project" to get started
            </p>
          </div>
        );
      }

      return (
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          {projects.map((project, index) => {
            const stats = getProjectStats(project);
            return (
              <div
                key={project.id}
                className="project-card rounded-xl p-6 animate-in"
                style={{ animationDelay: `${index * 0.1}s` }}
              >
                <div className="flex justify-between items-start mb-4">
                  <div className="flex-1">
                    <h3 className="text-xl font-bold mb-3" style={{ color: 'var(--charcoal)' }}>
                      {project.name}
                    </h3>
                    <div className="flex gap-2 mb-3">
                      <span className={`status-badge px-3 py-1 rounded-full ${getStatusColor(project.status)}`}>
                        {project.status}
                      </span>
                      <span
                        className="status-badge px-3 py-1 rounded-full font-semibold"
                        style={{ 
                          backgroundColor: `${getPriorityColor(project.priority)}20`,
                          color: getPriorityColor(project.priority)
                        }}
                      >
                        {project.priority}
                      </span>
                    </div>
                  </div>
                  <button
                    onClick={(e) => {
                      e.stopPropagation();
                      onDeleteProject(project.id);
                    }}
                    className="text-gray-400 hover:text-red-500 transition text-xl"
                  >
                    √ó
                  </button>
                </div>

                {project.description && (
                  <p className="text-sm mb-4 line-clamp-2" style={{ color: 'var(--warm-gray)' }}>
                    {project.description}
                  </p>
                )}

                {project.deadline && (
                  <div className="flex items-center gap-2 text-sm mb-4" style={{ color: 'var(--warm-gray)' }}>
                    <span>üìÖ</span>
                    <span>Due: {new Date(project.deadline).toLocaleDateString()}</span>
                  </div>
                )}

                <div className="mb-4">
                  <div className="flex justify-between text-sm mb-2" style={{ color: 'var(--warm-gray)' }}>
                    <span>Progress</span>
                    <span className="font-semibold">{stats.completed}/{stats.total} tasks</span>
                  </div>
                  <div className="w-full bg-gray-200 rounded-full h-2.5">
                    <div
                      className="h-2.5 rounded-full transition-all duration-500"
                      style={{ 
                        width: `${stats.progress}%`,
                        background: 'linear-gradient(90deg, var(--terra) 0%, var(--terra-light) 100%)'
                      }}
                    />
                  </div>
                </div>

                <button
                  onClick={() => onSelectProject(project)}
                  className="w-full py-2.5 bg-gray-50 hover:bg-gray-100 rounded-lg transition font-medium"
                  style={{ color: 'var(--charcoal)' }}
                >
                  View Details ‚Üí
                </button>
              </div>
            );
          })}
        </div>
      );
    }

    // ============================================
    // PROJECT VIEW
    // ============================================
    function ProjectView({ project, onBack, onUpdateProject, onAddTask, onToggleTask, onEditTask, onDeleteTask, onReorderTask }) {
      const [taskModalConfig, setTaskModalConfig] = useState({ isOpen: false, task: null });
      const [activeTab, setActiveTab] = useState('list');
      
      const [draggedTaskId, setDraggedTaskId] = useState(null);
      const [dragOverTaskId, setDragOverTaskId] = useState(null);

      const sortedTasks = [...(project.tasks || [])].sort((a, b) => a.order - b.order);

      const stats = {
        total: project.tasks?.length || 0,
        completed: project.tasks?.filter(t => t.completed).length || 0,
        progress: 0
      };
      stats.progress = stats.total > 0 ? (stats.completed / stats.total) * 100 : 0;

      const handleSaveTask = (taskData) => {
        if (taskModalConfig.task) {
          onEditTask(taskModalConfig.task.id, taskData);
        } else {
          onAddTask(project.id, taskData);
        }
        setTaskModalConfig({ isOpen: false, task: null });
      };

      const openAddTask = () => setTaskModalConfig({ isOpen: true, task: null });
      const openEditTask = (task) => setTaskModalConfig({ isOpen: true, task });

      const handleDrop = (e, targetTask, dropIndex) => {
        e.preventDefault();
        if (draggedTaskId === targetTask.id) return;

        const draggedIndex = sortedTasks.findIndex(t => t.id === draggedTaskId);
        let newOrder;
        
        if (draggedIndex < dropIndex) {
          const afterTarget = sortedTasks[dropIndex + 1];
          if (afterTarget) {
            newOrder = (targetTask.order + afterTarget.order) / 2;
          } else {
            newOrder = targetTask.order + 1000;
          }
        } else {
          const beforeTarget = sortedTasks[dropIndex - 1];
          if (beforeTarget) {
            newOrder = (beforeTarget.order + targetTask.order) / 2;
          } else {
            newOrder = targetTask.order - 1000;
          }
        }

        onReorderTask(draggedTaskId, newOrder);
        setDragOverTaskId(null);
        setDraggedTaskId(null);
      };

      return (
        <div className="animate-in">
          <button
            onClick={onBack}
            className="mb-6 flex items-center gap-2 font-medium hover:opacity-70 transition"
            style={{ color: 'var(--terra)' }}
          >
            ‚Üê Back to Dashboard
          </button>

          <div className="bg-white rounded-xl border-2 border-gray-200 p-8 mb-6">
            <h2 className="text-4xl font-bold mb-4" style={{ color: 'var(--charcoal)' }}>
              {project.name}
            </h2>
            {project.description && (
              <p className="text-lg mb-6" style={{ color: 'var(--warm-gray)' }}>
                {project.description}
              </p>
            )}

            <div className="grid grid-cols-2 md:grid-cols-4 gap-6">
              <div>
                <span className="text-sm" style={{ color: 'var(--warm-gray)' }}>Status</span>
                <p className="font-semibold text-lg capitalize" style={{ color: 'var(--charcoal)' }}>
                  {project.status}
                </p>
              </div>
              <div>
                <span className="text-sm" style={{ color: 'var(--warm-gray)' }}>Priority</span>
                <p className="font-semibold text-lg capitalize" style={{ color: 'var(--charcoal)' }}>
                  {project.priority}
                </p>
              </div>
              <div>
                <span className="text-sm" style={{ color: 'var(--warm-gray)' }}>Deadline</span>
                <p className="font-semibold text-lg" style={{ color: 'var(--charcoal)' }}>
                  {project.deadline ? new Date(project.deadline).toLocaleDateString() : 'None'}
                </p>
              </div>
              <div>
                <span className="text-sm" style={{ color: 'var(--warm-gray)' }}>Progress</span>
                <p className="font-semibold text-lg" style={{ color: 'var(--terra)' }}>
                  {Math.round(stats.progress)}%
                </p>
              </div>
            </div>
          </div>

          <div className="bg-white rounded-xl border-2 border-gray-200 p-8">
            <div className="flex justify-between items-center mb-2">
              <h3 className="text-2xl font-bold" style={{ color: 'var(--charcoal)' }}>
                Tasks ({stats.completed}/{stats.total})
              </h3>
              <button
                onClick={openAddTask}
                className="px-4 py-2 btn-primary text-white rounded-lg font-medium"
              >
                + Add Task
              </button>
            </div>

            <div className="flex gap-6 mb-6 border-b-2 border-gray-100">
              <button 
                onClick={() => setActiveTab('list')}
                className={`pb-3 font-bold text-lg border-b-4 transition ${activeTab === 'list' ? 'border-terra' : 'border-transparent hover:border-gray-300'}`}
                style={{ color: activeTab === 'list' ? 'var(--terra)' : 'var(--warm-gray)', borderColor: activeTab === 'list' ? 'var(--terra)' : '' }}
              >
                List View
              </button>
              <button 
                onClick={() => setActiveTab('gantt')}
                className={`pb-3 font-bold text-lg border-b-4 transition ${activeTab === 'gantt' ? 'border-terra' : 'border-transparent hover:border-gray-300'}`}
                style={{ color: activeTab === 'gantt' ? 'var(--terra)' : 'var(--warm-gray)', borderColor: activeTab === 'gantt' ? 'var(--terra)' : '' }}
              >
                Gantt Chart
              </button>
            </div>

            {activeTab === 'list' ? (
              <div className="space-y-3 animate-in">
                {(!sortedTasks || sortedTasks.length === 0) && (
                  <p className="text-center py-12" style={{ color: 'var(--warm-gray)' }}>
                    No tasks yet. Add one to get started!
                  </p>
                )}
                {sortedTasks.map((task, index) => {
                  const isDragging = draggedTaskId === task.id;
                  const isDragOver = dragOverTaskId === task.id;
                  
                  return (
                    <div
                      key={task.id}
                      draggable
                      onDragStart={(e) => {
                        setDraggedTaskId(task.id);
                        // REQUIRED for dragging to work in Firefox and Safari
                        e.dataTransfer.setData('text/plain', task.id);
                        e.dataTransfer.effectAllowed = 'move';
                      }}
                      onDragOver={(e) => {
                        e.preventDefault();
                        e.dataTransfer.dropEffect = 'move';
                        if (dragOverTaskId !== task.id) setDragOverTaskId(task.id);
                      }}
                      onDragLeave={() => setDragOverTaskId(null)}
                      onDrop={(e) => handleDrop(e, task, index)}
                      onDragEnd={() => {
                        setDragOverTaskId(null);
                        setDraggedTaskId(null);
                      }}
                      className={`flex items-center gap-4 p-4 rounded-lg transition border-2 group ${
                        isDragging ? 'opacity-40 scale-[0.99] border-dashed border-gray-300' : ''
                      } ${
                        isDragOver ? 'border-dashed bg-orange-50' : 'border-transparent hover:bg-gray-50 hover:border-gray-200'
                      }`}
                      style={{ 
                        animationDelay: `${index * 0.05}s`,
                        borderColor: isDragOver ? 'var(--terra)' : undefined
                      }}
                    >
                      <div className="flex-shrink-0 drag-handle text-gray-300 hover:text-gray-500 px-1" title="Drag to reorder">
                        <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 8h16M4 16h16"></path>
                        </svg>
                      </div>

                      <button
                        onClick={() => onToggleTask(task.id)}
                        className="flex-shrink-0 w-6 h-6 rounded-full border-2 flex items-center justify-center transition"
                        style={{
                          borderColor: task.completed ? 'var(--success-green)' : 'var(--warm-gray)',
                          backgroundColor: task.completed ? 'var(--success-green)' : 'transparent'
                        }}
                      >
                        {task.completed && <span className="text-white text-sm">‚úì</span>}
                      </button>

                      <div className="flex-1">
                        <span
                          className={`text-lg block font-semibold ${task.completed ? 'line-through opacity-50' : ''}`}
                          style={{ color: 'var(--charcoal)' }}
                        >
                          {task.title}
                        </span>
                        {(task.startDate || task.endDate) && (
                          <div className={`flex gap-3 text-sm mt-1 ${task.completed ? 'opacity-50' : ''}`} style={{ color: 'var(--warm-gray)' }}>
                            {task.startDate && <span><span className="font-bold">Start:</span> {new Date(task.startDate).toLocaleDateString()}</span>}
                            {task.endDate && <span><span className="font-bold">End:</span> {new Date(task.endDate).toLocaleDateString()}</span>}
                          </div>
                        )}
                      </div>
                      
                      {task.createdBy && (
                        <span className="text-sm mr-2 opacity-50 hidden md:block" style={{ color: 'var(--warm-gray)' }}>
                          {task.createdBy.split('@')[0]}
                        </span>
                      )}

                      <div className="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button 
                          onClick={() => openEditTask(task)} 
                          className="w-8 h-8 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center text-gray-600 transition"
                          title="Edit Task"
                        >
                          ‚úé
                        </button>
                        <button 
                          onClick={() => onDeleteTask(task.id)} 
                          className="w-8 h-8 rounded-full bg-red-50 hover:bg-red-100 flex items-center justify-center text-red-500 transition"
                          title="Delete Task"
                        >
                          √ó
                        </button>
                      </div>
                    </div>
                  );
                })}
              </div>
            ) : (
              <GanttView tasks={sortedTasks || []} />
            )}
          </div>
          
          {taskModalConfig.isOpen && (
            <TaskModal
              task={taskModalConfig.task}
              onSave={handleSaveTask}
              onClose={() => setTaskModalConfig({ isOpen: false, task: null })}
            />
          )}
        </div>
      );
    }

    // ============================================
    // TASK MODAL (ADD & EDIT)
    // ============================================
    function TaskModal({ task, onSave, onClose }) {
      const isEditing = !!task;
      const [formData, setFormData] = useState({
        title: task?.title || '',
        startDate: task?.startDate || '',
        endDate: task?.endDate || ''
      });

      const handleSubmit = (e) => {
        e.preventDefault();
        if (formData.title.trim()) {
          onSave(formData);
        }
      };

      return (
        <div className="fixed inset-0 bg-black bg-opacity-40 modal-backdrop flex items-center justify-center p-4 z-50">
          <div className="bg-white rounded-xl max-w-lg w-full p-8 border-2 border-gray-200 animate-in">
            <h3 className="text-3xl font-bold mb-6" style={{ color: 'var(--charcoal)' }}>
              {isEditing ? 'Edit Task' : 'New Task'}
            </h3>
            <form onSubmit={handleSubmit} className="space-y-5">
              <div>
                <label className="block text-sm font-semibold mb-2" style={{ color: 'var(--charcoal)' }}>
                  Task Title *
                </label>
                <input
                  type="text"
                  value={formData.title}
                  onChange={(e) => setFormData({ ...formData, title: e.target.value })}
                  className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg font-medium"
                  style={{ color: 'var(--charcoal)' }}
                  placeholder="Enter task name..."
                  required
                  autoFocus
                />
              </div>

              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-semibold mb-2" style={{ color: 'var(--charcoal)' }}>
                    Start Date (Optional)
                  </label>
                  <input
                    type="date"
                    value={formData.startDate}
                    onChange={(e) => setFormData({ ...formData, startDate: e.target.value })}
                    className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg font-medium"
                    style={{ color: 'var(--charcoal)' }}
                  />
                </div>

                <div>
                  <label className="block text-sm font-semibold mb-2" style={{ color: 'var(--charcoal)' }}>
                    End Date (Optional)
                  </label>
                  <input
                    type="date"
                    value={formData.endDate}
                    onChange={(e) => setFormData({ ...formData, endDate: e.target.value })}
                    className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg font-medium"
                    style={{ color: 'var(--charcoal)' }}
                  />
                </div>
              </div>

              <div className="flex gap-3 pt-4">
                <button
                  type="submit"
                  className="flex-1 py-3 btn-primary text-white rounded-lg font-semibold"
                >
                  {isEditing ? 'Save Changes' : 'Add Task'}
                </button>
                <button
                  type="button"
                  onClick={onClose}
                  className="flex-1 py-3 bg-gray-200 rounded-lg font-semibold"
                  style={{ color: 'var(--charcoal)' }}
                >
                  Cancel
                </button>
              </div>
            </form>
          </div>
        </div>
      );
    }

    // ============================================
    // ADD PROJECT MODAL
    // ============================================
    function AddProjectModal({ onAdd, onClose }) {
      const [formData, setFormData] = useState({
        name: '',
        description: '',
        status: 'active',
        priority: 'medium',
        deadline: ''
      });

      const handleSubmit = (e) => {
        e.preventDefault();
        if (formData.name.trim()) {
          onAdd(formData);
        }
      };

      return (
        <div className="fixed inset-0 bg-black bg-opacity-40 modal-backdrop flex items-center justify-center p-4 z-50">
          <div className="bg-white rounded-xl max-w-lg w-full p-8 border-2 border-gray-200 animate-in">
            <h3 className="text-3xl font-bold mb-6" style={{ color: 'var(--charcoal)' }}>
              New Project
            </h3>
            <form onSubmit={handleSubmit} className="space-y-5">
              <div>
                <label className="block text-sm font-semibold mb-2" style={{ color: 'var(--charcoal)' }}>
                  Project Name *
                </label>
                <input
                  type="text"
                  value={formData.name}
                  onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                  className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg font-medium"
                  style={{ color: 'var(--charcoal)' }}
                  required
                  autoFocus
                />
              </div>

              <div>
                <label className="block text-sm font-semibold mb-2" style={{ color: 'var(--charcoal)' }}>
                  Description
                </label>
                <textarea
                  value={formData.description}
                  onChange={(e) => setFormData({ ...formData, description: e.target.value })}
                  className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg font-medium"
                  style={{ color: 'var(--charcoal)' }}
                  rows="3"
                />
              </div>

              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-semibold mb-2" style={{ color: 'var(--charcoal)' }}>
                    Status
                  </label>
                  <select
                    value={formData.status}
                    onChange={(e) => setFormData({ ...formData, status: e.target.value })}
                    className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg font-medium"
                    style={{ color: 'var(--charcoal)' }}
                  >
                    <option value="active">Active</option>
                    <option value="on-hold">On Hold</option>
                    <option value="completed">Completed</option>
                  </select>
                </div>

                <div>
                  <label className="block text-sm font-semibold mb-2" style={{ color: 'var(--charcoal)' }}>
                    Priority
                  </label>
                  <select
                    value={formData.priority}
                    onChange={(e) => setFormData({ ...formData, priority: e.target.value })}
                    className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg font-medium"
                    style={{ color: 'var(--charcoal)' }}
                  >
                    <option value="low">Low</option>
                    <option value="medium">Medium</option>
                    <option value="high">High</option>
                  </select>
                </div>
              </div>

              <div>
                <label className="block text-sm font-semibold mb-2" style={{ color: 'var(--charcoal)' }}>
                  Deadline (Optional)
                </label>
                <input
                  type="date"
                  value={formData.deadline}
                  onChange={(e) => setFormData({ ...formData, deadline: e.target.value })}
                  className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg font-medium"
                  style={{ color: 'var(--charcoal)' }}
                />
              </div>

              <div className="flex gap-3 pt-4">
                <button
                  type="submit"
                  className="flex-1 py-3 btn-primary text-white rounded-lg font-semibold"
                >
                  Create Project
                </button>
                <button
                  type="button"
                  onClick={onClose}
                  className="flex-1 py-3 bg-gray-200 rounded-lg font-semibold"
                  style={{ color: 'var(--charcoal)' }}
                >
                  Cancel
                </button>
              </div>
            </form>
          </div>
        </div>
      );
    }

    // ============================================
    // RENDER APP
    // ============================================
    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
